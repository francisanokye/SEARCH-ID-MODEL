library(macpan2)
library(shellpipes)
rpcall("timevar_spec.Rout timevar_spec.R flows.rda params.rda")

loadEnvironments()

beta_changepoints <- c(0, 10, 25, 55, 90)
beta_values = c(0.3, 0.30, 0.34, 0.34, 0.33)

<<<<<<< HEAD
=======
reporting_changepoints <- c(0, 10, 25, 55, 90)
reporting_values = c(0.3, 0.30, 0.34, 0.34, 0.33)

>>>>>>> ff5249c5d699b32e7f8560e05460f67452dbb8b5
report_prob_ts = c(0.178277500297921, 0.178277500297921, 0.178277500297921, 0.178277500297921,
0.178277500297921, 0.178277500297921, 0.178277500297921, 0.178277500297921,
0.178277500297921, 0.178277500297921, 0.178277500297921, 0.178277500297921,
0.178277500297921, 0.178277500297921, 0.178277500297921, 0.178277500297921,
0.178277500297921, 0.178277500297921, 0.178277500297921, 0.178277500297921,
0.178277500297921, 0.178277500297921, 0.178277500297921, 0.178277500297921,
0.178277500297921, 0.178277500297921, 0.178277500297921, 0.178277500297921,
0.178277500297921, 0.178277500297921, 0.178277500297921, 0.178277500297921,
0.181465882199124, 0.184906305383687, 0.188608631862691, 0.192583345413292,
0.196841568335723, 0.201395077388073, 0.206256318663702, 0.211438421148947,
0.216955208670464, 0.222821209912375, 0.229051666153592, 0.235662536345531,
0.242670499120395, 0.250092951290545, 0.241332373665126, 0.248093025473852,
0.255175843403068, 0.262586989977925, 0.270332069645706, 0.278416016032408,
0.286842970590702, 0.295616152759514, 0.304737721898533, 0.314208631423761,
0.324028475753122, 0.334195330873641, 0.344705589563059, 0.355553792537453,
0.366732457050107, 0.378231904732789, 0.3900400907445, 0.402142436570202,
0.414521669087025, 0.427157668781444, 0.440027330250299, 0.453104438342837,
0.466359563491097, 0.479759979922151, 0.493269610537924, 0.506849002276325,
0.520455335721255, 0.534042472599292, 0.54756104457901, 0.560958586467815,
0.574179716475656, 0.587166365681855, 0.599858058200257, 0.612192242791729,
0.624104675827648, 0.635529854573493, 0.646401498751303, 0.656653077271336,
0.666218375917784, 0.675032100655618, 0.683030510123348, 0.690152069819687,
0.696338119512789, 0.701533544531294, 0.705687440869185, 0.708753763482162,
0.710691946800053, 0.711467486351825, 0.711052470516391, 0.709426051786517,
0.706574847570945, 0.702493261459435, 0.697183717027066, 0.690656797639342,
0.682931287312035, 0.67403410944492, 0.664000162145561, 0.702047136981477,
0.692010776386528, 0.680962377213444, 0.668954265567571, 0.656044357237575,
0.642295572064954, 0.627775193273236, 0.612554182264955, 0.596706460124288,
0.580308167529015, 0.563436914968113, 0.546171035080357, 0.528588848582737,
0.510767954661064, 0.492784555872015, 0.474712826585335, 0.456624332811123,
0.438587509948217, 0.420667203595395, 0.402924277128412, 0.385415288302563,
0.368192235730453, 0.351302374742476, 0.334788100893677, 0.318686898260269,
0.303031348692349, 0.28784919737007, 0.273163469357281, 0.258992631362135,
0.245350792595976, 0.232247938463023, 0.219690190802885, 0.207680088531758,
0.196216882769518, 0.185296840880838, 0.174913554279737, 0.165058245329591,
0.155720069195824, 0.146886407058759, 0.138543147653168, 0.130674954654646,
0.123265517968657, 0.116297787485687, 0.109754188337424, 0.10361681711814,
0.0978676189185829, 0.0924885453544496, 0.0874616940573505, 0.0827694303338541,
0.0783944918897123, 0.0743200776645277, 0.0705299219304903, 0.0670083548813954,
0.0637403509792344, 0.0607115663396547, 0.0579083664288863, 0.0553178453175894,
0.0393466401015737, 0.0370377956136838, 0.0348930874806082, 0.0329011699674882,
0.0310513631667731, 0.0293336327896827, 0.0277385672599485, 0.0262573527535189,
0.0248817467515825, 0.0236040506019699, 0.0224170815164088, 0.0213141443686641,
0.02028900360155, 0.0193358554992501, 0.0184493010352868, 0.0176243194657145,
0.0168562428014502, 0.0161407312628391, 0.0154737497932589, 0.0148515456864687,
0.0142706273641417, 0.0137277443252342, 0.013219868277172, 0.0127441754499228,
0.0122980300875222, 0.0118789691071809, 0.0117697543218102, 0.0113726752845545,
0.0109985640323127, 0.0106452723808571, 0.0103107925118877, 0.00999324522677816,
0.00969086964270289, 0.00940201427677885, 0.00912512946784713,
0.00885876108769779, 0.00860154549363774, 0.00835220567208293,
0.00810954851812255, 0.00787246318861922, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685, 0.00763992045631685, 0.00763992045631685,
0.00763992045631685)

spec <- mp_tmb_model_spec(
	before = list(N ~ N
		, E ~ exp(log_E0)
		, I ~ exp(log_I0)
		, R ~ exp(log_R0)
		, S ~ N - E - I - R
	)
	, during = flows
	, default = c(params)
)

newspec <- mp_tmb_update(spec
	, default = list(sigma = sigma
		, beta = beta
		, gamma = gamma
		, N = N
		, log_E0 = log(E0)
		, log_I0 = log(I0)
		, log_R0 = log(R0)
	)
)


## accumulate infections
nspec <- mp_tmb_insert(newspec
  , expression = list(serop ~ (R/N))#sero_cases ~ S * foi * report_prob 
  , at = Inf
  , phase = "during"
)

## update  model specification with piece-wise transmission rates
timevar_spec <- mp_tmb_insert(nspec
<<<<<<< HEAD
	, expression = list(report_prob ~ report_prob_ts[time_step(1)])
	, phase = "during", at = 1L
	, default = list(report_prob_ts = report_prob_ts)
=======
	, expression = list(
	    #beta ~ time_var(beta_values, beta_changepoints)
	   report_prob ~ report_prob_ts[time_step(1)]
	 )
	, phase = "during", at = 1L
	#, default = list(beta_values = beta_values, report_prob_ts = report_prob_ts)
	, default = list(report_prob_ts = report_prob_ts)
   #, integers = list(beta_changepoints = beta_changepoints)
>>>>>>> ff5249c5d699b32e7f8560e05460f67452dbb8b5
)

#timevar_spec <- mp_tmb_insert(timevar_spec
#   , expression = list(report_prob ~ time_var(reporting_values, reporting_changepoints))
#   , phase = "during", at = 1L
#   , default = list(reporting_values = reporting_values)
#   , integers = list(reporting_changepoints = reporting_changepoints)
#)


timevar_spec = mp_tmb_insert_reports(timevar_spec
  , incidence_name = "exposure"
  , report_prob = 0.5#0.1
  , mean_delay = 11
  , cv_delay = 0.95#0.25
  , reports_name = "cases"
  , report_prob_name = "report_prob"
)

rdsSave(timevar_spec)
